const express = require('express');
const router = express.Router();
const { query } = require('../database/db');
const { authMiddleware } = require('../middleware/auth');

// Get timetable for student/teacher
router.get('/', authMiddleware, async (req, res, next) => {
  try {
    let timetable;
    
    if (req.user.role === 'student') {
      timetable = await query(
        `SELECT t.*, u.name as teacher_name FROM timetable t
         LEFT JOIN users u ON t.teacher_id = u.id
         WHERE t.department = ? AND t.year = ? AND t.section = ? AND t.is_active = TRUE
         ORDER BY FIELD(t.day_of_week, 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'), t.time_slot`,
        [req.user.department, req.user.year, req.user.section]
      );
    } else if (req.user.role === 'teacher') {
      timetable = await query(
        `SELECT * FROM timetable WHERE teacher_id = ? AND is_active = TRUE
         ORDER BY FIELD(day_of_week, 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'), time_slot`,
        [req.user.id]
      );
    }

    res.json({ success: true, data: timetable });
  } catch (error) {
    next(error);
  }
});

module.exports = router;
